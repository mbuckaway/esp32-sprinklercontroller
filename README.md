# ESP32 Homekit Sprinker Controller

## Using the ESP32 Open Source SDK

[HomeKit](https://developer.apple.com/homekit/) is a framework developed by Apple for communicating with and controlling connected accessories in a userâ€™s home using iOS devices.
ESP HomeKit SDK has been developed in-house by Espressif to build Apple HomeKit compatible accessories using ESP32/ESP32-S2/ESP32-C3/ESP8266 SoCs.

> Note: If you want to use HomeKit for commercial products, please check [here](https://www.espressif.com/en/products/sdks/esp-homekit-sdk) for access to the MFi variant of this SDK. It has the exact same APIs as this and so, moving to it should be easy. However, commercial HomeKit products can be built only with ESP32/ESP32-S2/ESP32-C3 since ESP8266 cannot meet all the HomeKit Certification requirements.

> If you want to use a port of Apple's ADK instead, please check [here](https://github.com/espressif/esp-apple-homekit-adk)

The version of the HomeKit SDK used for this device cannot be used for a production device as it does not meet Apple's requirements. However, we are creating a one-off device for home use "hard coded" to the WIFI network in use, so it is sufficient.

## Get Started

### Hardware

The Hardware is a simple circuit. There is a ESP32 devkit module using three GPIO's to control a relay module. I've also used a 5V buck convertor IC to change the 24V required by the Sprinkler system valves to 5V to drive the ESP32 Devkit. The 3v3 volts required to run the ESP32 directly is generated by the chip on the devkit. I do this to allow the filter circuit on the devkit board to keep the design simple. I may generate a schematic in the future, if I get time.

Only the ESP32 is supported and not the ESP8266. I recommend using the ESP32 and not the ESP32S2 as this is a single core CPU, the WIFI driver takes alot CPU cycles.

### Software

This repo container everything you need to build the sprinkler controller. This includes the homekit SDK as a component and my WIFI lib as a component. Once the code is checked out, you must run 'updatemodules.sh' to get the submoduled link in the homekit SDK, or this project will not build.

## Building the Code

Check the source into a directory.

```text
$ idf.py menuconfig
$ idf.py build
$ idf.py build
$ idf.py monitor
```

For menuconfig, configure your WIFI settings (they are hard coded), and the GPIO ports for the valve relays. The Homekit ID's need not be changed unless you have multiple ESP32 homekit devices on your network. At this point, it is useful to use the monitor for the first time, but it is not strictly necessary as the device will appear in the home app anyways and you can always enter the code manually rather than scanning the QR code.

As the device boots up, you will see one QR code, a small one for HomeKit.  As you've hard coded your WIFI password into the device, setup is fast. You can scan the QR code in the Home app, or enter your code to load the device.

After the device connects to your Home Wi-Fi network it can be added in the Home app

### Adding the Sprinker Controller to the Home app

Open the Home app on your iPhone/iPad and follow these steps

- Tap on "Add Accessory" and scan the small QR code mentioned above.
- If QR code is not visible correctly, you may use the link printed on the serial terminal or follow these steps:
    - Choose the "I Don't Have a Code or Cannot Scan" option.
    - Tap on "Esp-Sprinker" in the list of Nearby Accessories.
    - Select the "Add Anyway" option for the "Uncertified Accessory" prompt.
    - Enter 11122333 as the Setup code (or whatever code use configured in menuconfig)
- You should eventually see the "Esp-Sprinker added" message.
- Give a custom name, assign to a room, create scenes as required and you are done.

### Issues with Adding Accessory

If Homekit things there is another accessory of the same code, it will cause a timeout issue adding this accessory. This somes happens when adding and deleting the accessory during testing. Make sure to check the monitor when the device boots up for the number of registered accessories. It should be zero. If you reset the device, you have to remove the device from the Home app. Generally speaking it is better to remove the device from the home app first, and them reset the device (which wipes it's homekit configuration).

### Using the Sprinkler Accessory

When you add this accessory to Homekit, it will appear as a Sprinkler. However, Homekit makes some assumptions about a sprinkler controller. It assumes the it has a timer and a scheduler built it, so control from Homekit it limited to turning the associated values on/off or enabling/disabling them manually. It also sets two statuses per value: active and inuse. These two status device what status is reported to Homekit. You will notice when you activate a value, it goes from off, to waiting, to running. Turning off the valve it runs through stopping, waiting, off. For this controller, this makes no sense as we are setting up automatations in Homekit to setup the schedule for the sprinkler. To further add to the confusion, the Home app does not allow Sprinkler values to be added to scenes or automations. I could, change the type to a switch in my code, but I found that the Eve app is more intelligent. It allows for Scenes and Automations for sprinkler values. I suggest switching from the Home app to the Eve app. Testing for rain can be done with the Shortcuts app testing for rain via the weather forecast (more info to come).

## Additional Information

The ESP32 Homekit SDK has most features than are used here. Please refer to their documentation for details.
